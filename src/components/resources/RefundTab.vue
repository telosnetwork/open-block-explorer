<script lang="ts">
import { API } from '@wharfkit/session';
import { api } from 'src/api';
import ViewTransaction from 'src/components/ViewTransanction.vue';
import { getChain } from 'src/config/ConfigManager';
import { useAccountStore } from 'src/stores/account';
import { useChainStore } from 'src/stores/chain';
import { Token } from 'src/types';
import { formatCurrency } from 'src/utils/string-utils';
import { computed, defineComponent, ref } from 'vue';

export default defineComponent({
    name: 'RefundTab',
    components: {
        ViewTransaction,
    },
    setup() {
        const accountStore = useAccountStore();
        const chainStore = useChainStore();
        const openTransaction = ref<boolean>(false);
        const stakingAccount = ref<string>('');
        const total = ref<string>('0');
        const progress = ref<number>(0.2);
        const refundRequest = computed(() => accountData.value?.refund_request);
        const cpuAmount = computed(
            (): number => refundRequest.value?.cpu_amount.value,
        );
        const netAmount = computed(
            (): number => refundRequest.value?.net_amount.value,
        );
        const token = computed((): Token => chainStore.token);
        const accountData = computed(() => accountStore.data as API.v1.AccountObject);
        const totalRefund = computed((): string => {
            const totalRefund = refundRequest.value
                ? formatCurrency((refundRequest.value.cpu_amount.value + refundRequest.value.net_amount.value), 4)
                : 0;
            return `${totalRefund} ${token.value.symbol}`;
        });

        function formatStaked(staked: number): string {
            const stakedValue = staked / Math.pow(10, token.value.precision);
            return formatCurrency(stakedValue, 2, token.value.symbol);
        }

        function refundProgress(): number {
            let diff =
                Math.round(
                    new Date(
                        new Date(
                            accountData.value.refund_request?.request_time.toString() + 'Z',
                        ).toUTCString(),
                    ).getTime() / 1000,
                ) +
                259200 -
                Math.round(new Date(Date.now()).getTime() / 1000);
            let time = diff / 259200;
            return time > 0 ? time : 0;
        }

        function refundCountdown(): string {
            let diff =
                Math.round(
                    new Date(
                        new Date(
                            accountData.value?.refund_request?.request_time.toString() + 'Z',
                        ),
                    ).getTime() / 1000,
                ) +
                259200 -
                Math.round(new Date(new Date().toISOString()).getTime() / 1000);
            if (diff > 0) {
                const days = component(diff, 24 * 60 * 60), // calculate days from timestamp
                    hours = component(diff, 60 * 60) % 24; // hours
                return `${days} days, ${hours} hours remaining`;
            } else {
                return 'No pending refund';
            }
        }

        function component(x: number, v: number) {
            return Math.floor(x / v);
        }

        return {
            accountStore,
            openTransaction,
            stakingAccount,
            total,
            totalRefund,
            accountData,
            refundRequest,
            cpuAmount,
            netAmount,
            token,
            progress,
            formatStaked,
            refundProgress,
            refundCountdown,
            transactionId: ref<string>(null),
            transactionError: null,
        };
    },
    methods: {
        async sendTransaction(): Promise<void> {
            this.transactionError = '';
            const data = {
                owner: this.accountData.account_name,
                transfer: false,
            };
            try {
                await this.accountStore.sendAction({
                    account: 'eosio',
                    name: 'refund',
                    data,
                });

                this.transactionId = this.accountStore.TransactionId;
            } catch (e) {
                this.transactionError = e;
                this.accountStore.setTransactionError(e);
            }
            await this.loadAccountData();

            if (localStorage.getItem('autoLogin_' + getChain().getChainId()) !== 'cleos') {
                this.openTransaction = true;
            }
        },
        async loadAccountData(): Promise<void> {
            try {
                const data = await api.getAccount(
                    this.accountStore.abi.account_name,
                );
                this.accountStore.setAccountData(data);
            } catch (e) {
                return;
            }
        },
    },
});
</script>

<template>

<div class="q-pt-lg">
    <div class="container-refund">
        <div class="row full-width">
            <div class="row full-width q-pt-lg q-px-lg">
                <div class="col-6 text-h6 grey-3">Refunding Total</div>
                <div class="col-6 text-h6 text-right grey-3">{{ totalRefund }}</div>
            </div>
            <div class="row full-width q-py-md">
                <hr>
            </div>
            <div class="row full-width q-pb-lg text-grey-3 text-weight-light">
                <div class="col-xs-12 col-sm-6 q-px-lg q-pt-sm">
                    <div class="row">
                        <div class="col-6">CPU</div>
                        <div class="col-6 text-right text-weight-bold">{{ cpuAmount || '0'}}</div>
                    </div>
                    <div class="row q-pt-md">
                        <div class="col-6">NET</div>
                        <div class="col-6 text-right text-weight-bold">{{ netAmount || '0'}}</div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-6 q-px-lg q-pt-sm">
                    <div class="row">
                        <div class="col-7">{{refundCountdown()}}</div>
                        <div class="col-5 text-right text-weight-bold">
                            <q-linear-progress class="q-mt-sm" :value="refundProgress()" color="grey-3"/>
                        </div>
                    </div>
                    <div class="row q-pt-sm">
                        <div class="col-7 q-pt-sm">Refund
                            <q-icon class="q-ml-xs" name="far fa-question-circle">
                                <q-tooltip class="bg-deep-purple-12" anchor="top middle" self="center middle">If it has been more than 72 hours since your unstake transaction. Click on Refund to claim your tokens.</q-tooltip>
                            </q-icon>
                        </div>
                        <div class="col-5 text-right grey-3">
                            <q-btn
                                class="full-width button-accent"
                                label="Refund"
                                flat
                                @click="sendTransaction"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <ViewTransaction
            v-model="openTransaction"
            :transactionId="transactionId"
            :transactionError="transactionError || ''"
            message="transaction complete"
        />
    </div>
</div>
</template>

<style lang="sass">
.button-accent
    background: rgba(108, 35, 255, 1)
    border-radius: 4px
    color: $grey-4
.container-refund
  border: 1px solid $grey-8
  border-radius: 13px
.grey-3
  color: $grey-3
</style>
